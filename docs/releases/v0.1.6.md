# Gonimbus v0.1.6 Release Notes

**Release Date**: 2026-01-25
**Status**: Content Inspection with Range Requests

## Overview

Gonimbus v0.1.6 introduces content inspection commands that read object headers without downloading entire files, using HTTP Range requests for efficiency.

Key capabilities:

1. **Content Inspection Commands** (`content head`) - read first N bytes with JSONL-only output
2. **Range Request Support** - efficient partial reads via HTTP Range headers
3. **Clear command taxonomy** - `stream` for full content, `content` for inspection

## The Problem

Applications often need to inspect file headers (magic bytes, XML declarations, schema identifiers) to make routing or processing decisions. Traditional approaches require downloading entire files:

- **Wasteful**: Download 100MB file to read 4KB header
- **Slow**: Full download before any decision can be made
- **Complex**: Managing partial reads with provider SDKs

## The Solution: `content` Commands

### `gonimbus content head`

Reads the first N bytes of an object using HTTP Range requests:

```bash
# Read first 4KB (default)
gonimbus content head s3://bucket/path/to/file.xml --profile my-profile

# Read first 256 bytes (magic bytes, file headers)
gonimbus content head s3://bucket/path/to/file.xml --bytes 256 --profile my-profile
```

Output is a single `gonimbus.content.head.v1` JSONL record:

```json
{
  "type": "gonimbus.content.head.v1",
  "ts": "2026-01-25T12:00:00Z",
  "job_id": "...",
  "provider": "s3",
  "data": {
    "uri": "s3://bucket/path/to/file.xml",
    "key": "path/to/file.xml",
    "bytes_requested": 4096,
    "bytes_returned": 4096,
    "content_b64": "PD94bWwgdmVyc2lvbj0iMS4wIi4uLg==",
    "etag": "60eda68512f8238bd2ba9abac0de63d7",
    "size": 3729736,
    "last_modified": "2025-12-15T20:53:44Z",
    "content_type": "application/xml"
  }
}
```

## Command Taxonomy: stream vs content

v0.1.6 establishes a clear taxonomy for data access commands:

| Command        | Output Format | Bytes Delivered        | Use Case                        |
| -------------- | ------------- | ---------------------- | ------------------------------- |
| `stream head`  | JSONL only    | None (metadata only)   | Routing decisions, size checks  |
| `stream get`   | Mixed framing | Full object (raw)      | Content download for processing |
| `content head` | JSONL only    | First N bytes (base64) | Header inspection, magic bytes  |

**Key insight**:

- **`stream`** commands are for **delivery** - getting data to downstream processors
- **`content`** commands are for **inspection** - examining data for routing/decisions

### Why Base64?

`content head` encodes bytes as base64 in the JSONL payload:

- **JSONL-only output**: No mixed framing, easy to parse with `jq`
- **Safe for all content**: Binary-safe encoding
- **Small payloads**: First N bytes are typically small (4KB default)

For full content delivery, use `stream get` which avoids base64 overhead.

## Range Request Support

### ObjectRanger Interface

The provider capability system now includes `ObjectRanger`:

```go
type ObjectRanger interface {
    GetRange(ctx context.Context, key string, start, endInclusive int64) (
        body io.ReadCloser, contentLength int64, err error)
}
```

Semantics:

- `start` and `endInclusive` follow HTTP Range header conventions
- Providers that don't support ranges fall back to GetObject with LimitReader

### S3 Implementation

The S3 provider implements `ObjectRanger` with:

- Standard HTTP Range header (`Range: bytes=0-4095`)
- Works with AWS S3, Wasabi, Cloudflare R2, and other S3-compatible stores
- Cloud integration tests validate behavior across providers

## Performance

Range requests minimize data transfer:

| Operation                  | Data Transferred | Latency |
| -------------------------- | ---------------- | ------- |
| Full download (100MB file) | 100 MB           | ~10s    |
| content head --bytes 4096  | 4 KB             | <100ms  |

For files where only the header matters, this is a 25,000x reduction in data transfer.

## Use Cases

### File Type Detection

Inspect magic bytes without downloading entire files:

```bash
# Read first 16 bytes for magic number detection
gonimbus content head s3://bucket/data/file --bytes 16 --profile prod | \
  jq -r '.data.content_b64' | base64 -d | xxd
```

### XML Declaration Extraction

Extract XML version and encoding from document headers:

```bash
# Read first 256 bytes for XML declaration
gonimbus content head s3://bucket/data/doc.xml --bytes 256 --profile prod | \
  jq -r '.data.content_b64' | base64 -d | head -1
```

### Content-Aware Routing

Make routing decisions based on file headers without full download:

```bash
# Route based on file format signature
header=$(gonimbus content head s3://bucket/file --bytes 64 --profile prod | \
  jq -r '.data.content_b64' | base64 -d)

case "$header" in
  *"<?xml"*) echo "XML document" ;;
  *"PK"*) echo "ZIP archive" ;;
  *) echo "Unknown format" ;;
esac
```

### Schema Version Detection

Identify schema versions in structured data:

```bash
# Check JSON schema version in first 1KB
gonimbus content head s3://bucket/data/record.json --bytes 1024 --profile prod | \
  jq -r '.data.content_b64' | base64 -d | jq '.schema_version'
```

## Changes

### Added

**Content Commands:**

- `gonimbus content head <uri>` - read first N bytes with JSONL output
- `--bytes N` flag to control read size (default: 4096)
- Base64-encoded content in `content_b64` field
- Full metadata (etag, size, last_modified, content_type)

**Provider Capabilities:**

- `ObjectRanger` interface for byte-range reads
- S3 provider implementation with Range header support
- Automatic fallback to GetObject when ranges not supported

**Content Package (`pkg/content/`):**

- `HeadBytes(ctx, provider, key, n)` - single-key content head
- `HeadBytesMulti` - parallel multi-key operations
- Provider capability detection for optimal path selection

### Changed

- Error handling consistent with stream commands (errors on stdout as `gonimbus.error.v1`)

## Upgrade Notes

No breaking changes from v0.1.5. Upgrade with:

```bash
go install github.com/3leaps/gonimbus/cmd/gonimbus@v0.1.6
```

## What's Next

v0.1.7 will focus on:

- Index checkpoints and recovery (`index recover`, `index checkpoint`)
- Enhanced `index doctor --locks` for WAL/SHM detection
- Process management primitives via sysprims integration

## Contributors

- Dave Thompson (@3leapsdave)

## License

Apache License 2.0 - see [LICENSE](../../LICENSE)
