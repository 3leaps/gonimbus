# Gonimbus v0.1.3 Release Notes

**Release Date**: 2026-01-15
**Status**: Local Index for Large-Scale Bucket Inventory

## Overview

Gonimbus v0.1.3 adds a local index store for offline bucket inventory. For buckets with millions of objects, the index enables fast repeated queries without re-enumerating via the provider API.

This release establishes two distinct workflows:

| Workflow      | Scale       | Commands                     | Index Required? |
| ------------- | ----------- | ---------------------------- | --------------- |
| **Explore**   | <1M objects | `tree`, `inspect`, `crawl`   | No              |
| **Inventory** | 1M+ objects | `index build`, `index query` | Yes             |

## Index Workflow

### The Problem

Cloud object stores (S3, GCS, etc.) are prefix-indexed. Queries with leading wildcards like `**/report-*.xml` cannot derive a prefix and require full bucket enumeration. At scale, this becomes impractical:

- 100K objects: ~30 seconds
- 1M objects: ~5 minutes
- 10M objects: ~1 hour
- 100M+ objects: hours to days

### The Solution

Build an index once, query it many times:

```bash
# Build index from crawl
gonimbus index build --job index-manifest.yaml

# Query instantly (no live enumeration)
gonimbus index query 's3://bucket/prefix/' --pattern '**/report-*.xml' --count
```

### Index Commands

```bash
# Initialize local index database
gonimbus index init

# Build index from manifest
gonimbus index build --job <manifest>

# List local indexes
gonimbus index list

# Query indexed objects
gonimbus index query <uri> --pattern <glob> [--count]

# Query with metadata filters
gonimbus index query <uri> --after 2025-12-01 --before 2026-01-01 --min-size 1KB

# View index statistics
gonimbus index stats <uri>

# Validate index integrity
gonimbus index doctor [--detail]

# Display manifest provenance
gonimbus index show <uri>

# Clean up old indexes
gonimbus index gc [--keep-last N] [--max-age 30d] [--dry-run]
```

### Index Manifest

Index builds require an explicit manifest with provider identity:

```yaml
version: "1.0"

connection:
  provider: s3
  bucket: my-bucket
  region: us-east-1
  base_uri: s3://my-bucket/data/

identity:
  storage_provider: aws_s3
  cloud_provider: aws
  region_kind: aws
  region: us-east-1
  endpoint_host: "" # empty for native AWS

build:
  match:
    includes:
      - "**/*"
  crawl:
    concurrency: 16

output:
  destination: stdout
```

**S3-Compatible Example (Wasabi):**

```yaml
connection:
  provider: s3
  bucket: my-bucket
  region: us-east-2
  endpoint: https://s3.us-east-2.wasabisys.com
  base_uri: s3://my-bucket/data/

identity:
  storage_provider: wasabi
  cloud_provider: other
  region_kind: aws
  region: us-east-2
  endpoint_host: s3.us-east-2.wasabisys.com
```

### Index Identity

Each index is uniquely identified by:

- `base_uri` - The prefix being indexed
- `provider_identity` - Provider, region, endpoint
- `build_params_hash` - Include patterns and configuration

This ensures indexes are isolated and can be safely reused or replaced.

### Query Filters

Index queries support the same filters as `inspect`:

| Filter      | Flag         | Example                            |
| ----------- | ------------ | ---------------------------------- |
| Pattern     | `--pattern`  | `**/data/*.parquet`                |
| Min size    | `--min-size` | `1KB`, `100MB`                     |
| Max size    | `--max-size` | `1GB`                              |
| After date  | `--after`    | `2025-12-01`                       |
| Before date | `--before`   | `2026-01-01`                       |
| Count only  | `--count`    | (returns count instead of records) |

### Index Lifecycle

Indexes are local snapshots that can be refreshed and aged out:

```bash
# Rebuild to capture changes
gonimbus index build --job index-manifest.yaml

# Clean up old runs (keep last 3)
gonimbus index gc --keep-last 3

# Clean up by age
gonimbus index gc --max-age 30d

# Preview cleanup
gonimbus index gc --keep-last 1 --dry-run
```

## Explore Workflow (No Index)

For smaller buckets, the existing commands work well:

```bash
# Discover structure
gonimbus tree s3://bucket/prefix/ --depth 2 --output table

# Quick inspection with filters
gonimbus inspect s3://bucket/prefix/ --min-size 1KB --limit 100

# Full crawl to JSONL
gonimbus crawl --job crawl-manifest.yaml
```

## Changes

### Added

**Index Workflow:**

- Local index store with SQLite backend (`pkg/indexstore/`)
- Index CLI commands: `init`, `build`, `list`, `query`, `stats`, `doctor`, `show`, `gc`
- Per-index database isolation with hash-based identity
- Streaming batch ingestion from crawl results
- Soft-delete handling for removed objects
- Build-time include patterns for scope control
- Derived prefix display during builds
- Index manifest schema with provider identity

**Query Features:**

- Pattern matching with doublestar globs
- Metadata filters: `--min-size`, `--max-size`, `--after`, `--before`
- Count mode for quick totals
- JSONL output for tooling integration

**Operations:**

- Index integrity validation (`doctor`)
- Manifest provenance display (`show`)
- Garbage collection with retention policies (`gc`)

### Changed

- Index set identity includes provider identity hash for isolation
- Index runs track partial/failed status for operational visibility

## Performance

**Query Speedup:**

| Operation         | Live Crawl | Index Query | Improvement |
| ----------------- | ---------- | ----------- | ----------- |
| Count all objects | ~30s       | <1s         | 100x+       |
| Pattern + filter  | minutes    | <1s         | 100-1000x   |

**Build Throughput:**

- ~3,000 objects/sec ingestion rate
- Linear scaling with object count
- Tested with 16M objects enumerated, 150K indexed (with filters)

## Known Limitations

- **Build-time date filters**: Metadata-based date filtering (`--after`/`--before`) is query-time only. Build-time filtering uses include patterns.
- **S3 Inventory**: Not yet supported as an index source (crawl-backed only in v0.1.3).
- **Path-date extraction**: Schema defined but not wired in v0.1.3.

## Test Coverage

| Package          | Coverage | Notes                   |
| ---------------- | -------- | ----------------------- |
| `pkg/indexstore` | 85%      | New package             |
| `pkg/manifest`   | 92%      | +5% from index schema   |
| `internal/cmd`   | 52%      | +4% from index commands |

## Upgrade Notes

No breaking changes from v0.1.2. Upgrade with:

```bash
go install github.com/3leaps/gonimbus/cmd/gonimbus@v0.1.3
```

**Migration Tips:**

- Use `index build` for buckets where repeated queries justify the build time
- Start with `index list` to see available indexes
- Use `index doctor` to validate index integrity after upgrades

## Contributors

- Dave Thompson (@3leapsdave)

## Dependencies

### New Runtime Dependencies

- `github.com/tursodatabase/go-libsql` - SQLite-compatible database driver

### New Test Dependencies

None

## License

Apache License 2.0 - see [LICENSE](../../LICENSE)
