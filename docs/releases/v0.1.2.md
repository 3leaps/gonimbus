# Gonimbus v0.1.2 Release Notes

**Release Date**: 2026-01-11
**Status**: Transfer Engine, Tree Command, Advanced Filtering

## Overview

Gonimbus v0.1.2 is a feature-rich release that adds comprehensive transfer operations, preflight permission probing, parallel prefix discovery for large-scale enumeration, a new tree command for prefix summaries, advanced metadata filtering, and a global readonly safety latch. This release is organized by workflow to help users understand the capabilities available for each command.

## Transfer Workflow

### Transfer Engine

The `gonimbus transfer` command copies or moves objects between S3-compatible buckets with manifest-driven configuration.

**Quick Start:**

```bash
# Validate manifest and check permissions
gonimbus preflight --job transfer.yaml --dry-run

# Execute transfer
gonimbus transfer --job transfer.yaml
```

**Transfer Manifest Example:**

```yaml
version: "1.0"

source:
  provider: s3
  bucket: source-bucket
  region: us-east-1

target:
  provider: s3
  bucket: target-bucket
  region: us-west-2

match:
  includes:
    - "data/**/*.parquet"
  excludes:
    - "**/_temporary/**"

transfer:
  mode: copy
  concurrency: 16
  on_exists: skip
  path_template: "archive/{key}"
  dedup:
    enabled: true
    strategy: etag
  sharding:
    enabled: true
    depth: 2
    list_concurrency: 16
```

**Features:**

| Feature        | Description                                                       |
| -------------- | ----------------------------------------------------------------- |
| Copy/Move      | Copy objects (keep source) or move (delete after copy)            |
| Path Templates | Transform destination keys with `{filename}`, `{dir[n]}`, `{key}` |
| On-Exists      | `skip` (default), `overwrite`, or `fail`                          |
| Deduplication  | Skip by ETag (default), key, or always transfer                   |
| Sharding       | Parallel prefix discovery for large buckets                       |

**Path Transformation Examples:**

```yaml
# Flatten: region/store/device/2024/01/file.json → file.json
path_template: "{filename}"

# Date-first: region/store/device/2024/01/file.json → 2024/01/region/file.json
path_template: "{dir[3]}/{dir[4]}/{dir[0]}/{filename}"

# Add prefix: data/file.json → archive/2024/data/file.json
path_template: "archive/2024/{key}"
```

**Cross-Account Transfers:**

```yaml
source:
  provider: s3
  bucket: source-bucket
  profile: source-account

target:
  provider: s3
  bucket: target-bucket
  profile: target-account
```

**S3-Compatible Storage:**

```yaml
source:
  provider: s3
  bucket: wasabi-bucket
  endpoint: https://s3.us-east-2.wasabisys.com
  region: us-east-2
```

### Preflight Permission Probing

Preflight checks verify permissions before expensive enumeration or transfer operations.

**Modes:**

| Mode          | Provider Calls  | Use Case                      |
| ------------- | --------------- | ----------------------------- |
| `plan-only`   | None            | Validate manifest syntax only |
| `read-safe`   | List, Head, Get | Validate read permissions     |
| `write-probe` | Above + probes  | Validate write permissions    |

**Probe Strategies:**

| Strategy          | Operation                       | Side Effects       |
| ----------------- | ------------------------------- | ------------------ |
| `multipart-abort` | Create + abort multipart upload | None (preferred)   |
| `put-delete`      | Put 0-byte + delete             | Minimal (fallback) |

**Capability Checks:**

Preflight validates capabilities in fail-fast order:

1. `target.write` (write-probe mode only)
2. `source.list`
3. `source.read`
4. `target.head` (when `on_exists != overwrite`)

**Standalone Preflight Command:**

```bash
# Check permissions before transfer
gonimbus preflight --job transfer.yaml
```

### Parallel Prefix Discovery

Sharding parallelizes prefix enumeration for buckets with millions of objects.

**Configuration:**

```yaml
transfer:
  sharding:
    enabled: true
    depth: 2
    list_concurrency: 16
```

**Performance Benchmarks:**

Tested with 4K prefixes (scales to millions):

| Configuration | Time  | Speedup |
| ------------- | ----- | ------- |
| Sequential    | 21.2s | 1.0x    |
| Parallel (8)  | 3.2s  | 6.6x    |
| Parallel (16) | 2.2s  | 9.5x    |
| Parallel (32) | 1.5s  | **14x** |

**For Operators:**

- `list_concurrency: 16` is recommended default
- Use `32` for very large workloads
- Set `depth` based on prefix depth (e.g., `2` for `a/b/c/` structures)

## Tree Workflow

### Tree Command

The `gonimbus tree` command provides directory-like summaries of object-store prefixes.

**Quick Start:**

```bash
# Direct prefix summary (non-recursive)
gonimbus tree s3://my-bucket/data/2026/

# Human-readable table output
gonimbus tree s3://my-bucket/data/ --output table
```

**Depth-Limited Traversal:**

```bash
# Traverse two levels
gonimbus tree s3://my-bucket/production/ --depth 2

# With safety limits
gonimbus tree s3://my-bucket/production/ \
  --depth 3 \
  --timeout 10m \
  --max-prefixes 50000
```

**Traversal Scope:**

```bash
# Include/exclude patterns control traversal scope
gonimbus tree s3://my-bucket/production/ \
  --depth 4 \
  --include 'production/kickback/**' \
  --exclude '**/_temporary/**'
```

**Partial Results:**

When hitting safety limits (timeout, max-prefixes):

- Streams computed `gonimbus.prefix.v1` records
- Emits final `gonimbus.error.v1` indicating partial run
- Emits final `gonimbus.summary.v1` with error count

```bash
# Capture partial results for analysis
gonimbus tree s3://my-bucket/production/ \
  --depth 3 \
  --timeout 30s \
  --output jsonl > tree-partial.jsonl
```

**Output Formats:**

| Format  | Description                            |
| ------- | -------------------------------------- |
| `jsonl` | Default, streaming JSON Lines          |
| `table` | Human-readable table with sizes/counts |

**Safety Limits:**

| Flag             | Default | Purpose                            |
| ---------------- | ------- | ---------------------------------- |
| `--timeout`      | 10m     | Maximum runtime                    |
| `--max-prefixes` | 50000   | Maximum prefixes to visit          |
| `--max-objects`  | none    | Maximum objects to list per prefix |
| `--max-pages`    | none    | Maximum pages per prefix           |

**Performance Note:**

Depth traversal uses parallel prefix enumeration internally. For large-scale trees:

| Configuration | Result              |
| ------------- | ------------------- |
| `parallel=1`  | Timeout (10m limit) |
| `parallel=32` | 25s completion      |

## Inspect Workflow

### Advanced Filtering

Advanced metadata filtering refines results beyond glob matching.

**Size Filtering:**

```bash
# Skip zero-byte marker files
gonimbus inspect s3://my-bucket/data/ --min-size 1

# Size range with units (KB/KiB, MB/MiB, GB/GiB)
gonimbus inspect s3://my-bucket/data/ \
  --min-size 1KB \
  --max-size 100MB
```

**Date Filtering:**

```bash
# Date range (ISO 8601)
gonimbus inspect s3://my-bucket/data/ \
  --after 2024-01-01 \
  --before 2024-06-30

# With datetime
gonimbus inspect s3://my-bucket/data/ \
  --after 2024-01-15T10:30:00Z
```

**Key Regex Filtering:**

```bash
# JSON files only
gonimbus inspect s3://my-bucket/data/ --key-regex '\.json$'

# Transaction-like keys
gonimbus inspect s3://my-bucket/data/ --key-regex 'TXN-\d{8}'
```

**Manifest Configuration:**

```yaml
match:
  includes:
    - "fixtures/v0.1.2/tier-b/**"
  filters:
    size:
      min: 1KB
      max: 100MB
    modified:
      after: 2026-01-01
      before: 2026-02-01
    key_regex: "\\.parquet$"
```

**Filter Semantics:**

- Size bounds are **inclusive** (`min <= size <= max`)
- Date bounds are **exclusive** (`after` requires `LastModified > after`)
- Key regex is applied **after** glob matching

## General & Safety

### Global Readonly Safety Latch

The readonly safety latch blocks provider-side mutations for dogfooding and lower-trust automation.

**Usage:**

```bash
# Environment variable
export GONIMBUS_READONLY=1

# CLI flag
gonimbus transfer --job transfer.yaml --readonly=false
```

**What It Blocks:**

- Transfer jobs (copy/move operations)
- Write-probe preflight (still allows `plan-only` and `read-safe`)

**Use Cases:**

- Dogfooding on real buckets
- Lower-trust automation/agents
- Testing commands without side effects

## Changes

### Added

**Transfer Workflow:**

- Transfer engine with manifest-driven copy/move operations
- Preflight permission probing with three modes
- Parallel prefix discovery (sharding) with 14x speedup
- Path transformation templates for destination keys
- Deduplication strategies (etag, key, none)
- Standalone `preflight` command for dogfooding

**Tree Workflow:**

- `tree` command for prefix summaries
- Depth-limited traversal with safety limits
- Table output with formatted sizes and counts
- JSONL output for streaming and partial results
- Include/exclude patterns for traversal scope

**Inspect Workflow:**

- Size filtering with KB/KiB, MB/MiB, GB/GiB units
- Date filtering with ISO 8601 dates/datetimes
- Key regex filtering with Go regexp syntax

**General:**

- Global readonly safety latch (`--readonly`, `GONIMBUS_READONLY`)
- Transfer manifest schema with `sharding`, `path_template`, `dedup` fields
- Job manifest schema with `preflight` and `filters` fields
- Capability interfaces for provider write/delete operations

**Documentation:**

- Transfer operations guide: `docs/user-guide/transfer.md`
- Preflight probing app note: `docs/appnotes/preflight.md`
- Examples cookbook: `docs/user-guide/examples/README.md`
- Tree examples: `docs/user-guide/examples/tree.md`
- Advanced filtering examples: `docs/user-guide/examples/advanced-filtering.md`

### Changed

- Preflight probe ordering: write probes now run before read probes for faster fail-fast
- Transfer manifest extended with `sharding`, `path_template`, `dedup` configuration
- Job manifest extended with `preflight` and `filters` configuration sections

### Fixed

- Fixed "failed to rewind transport stream for retry" errors during transfer (seekable buffering)
- Fixed missing duration field in tree summary records
- Fixed table output serialization for timeout/partial results
- Ensure tree summary is emitted even when timeout occurs
- Fixed timeout producing FATAL instead of clean partial output with `error.v1` + `summary.v1`

## Test Coverage

| Package           | Coverage | Notes                 |
| ----------------- | -------- | --------------------- |
| `pkg/transfer`    | 94%      | New package           |
| `pkg/preflight`   | 91%      | New package           |
| `pkg/shard`       | 88%      | New package           |
| `pkg/match`       | 98%      | +12% from filter      |
| `pkg/provider/s3` | 97%      | Unchanged             |
| `pkg/crawler`     | 86%      | Unchanged             |
| `internal/cmd`    | 48%      | +2% from new commands |

## Known Limitations

- **Sharding Depth**: Requires understanding prefix depth; incorrect depth can limit parallelism
- **ETag Dedup**: May not work reliably for multipart uploads or server-side encrypted objects
- **Tree Traversal**: Include/exclude are traversal-scope controls, not general search
- **Preflight Probes**: Versioned buckets may create delete markers; object lock may prevent deletes
- **Date Filtering**: Requires HEAD metadata (not available in listing-only mode)

## Upgrade Notes

No breaking changes from v0.1.1. Upgrade with:

```bash
go install github.com/3leaps/gonimbus/cmd/gonimbus@v0.1.2
```

**Migration Tips:**

- Transfer manifests now support `sharding` configuration for improved performance on large buckets
- Preflight modes: use `write-probe` for production transfers to validate write permissions early
- Tree command: use `--timeout` and `--max-prefixes` to bound traversal work on large buckets
- Advanced filters: available in both `inspect` CLI flags and `crawl` manifest configuration

## Contributors

- Dave Thompson (@3leapsdave)

## Dependencies

### New Runtime Dependencies

None (uses existing AWS SDK v2 dependencies)

### New Test Dependencies

- `motoserver/moto:latest` (Docker, for cloud integration tests)

## License

Apache License 2.0 - see [LICENSE](../../LICENSE)
