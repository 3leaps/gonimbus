# Gonimbus v0.1.7 Release Notes

**Release Date**: 2026-01-28
**Status**: Transfer Reflow with Content-Aware Routing

## Overview

Gonimbus v0.1.7 delivers the complete transfer reflow pipeline, enabling content-aware data reorganization across cloud storage providers and local filesystems.

Key capabilities:

1. **Transfer Reflow** (`transfer reflow`) - copy objects while rewriting keys based on templates
2. **Content Probe** (`content probe`) - extract derived fields from object content for routing decisions
3. **file:// Provider** - bucket-to-local filesystem transfers
4. **Collision Handling** - detect and handle destination conflicts

## The Problem

Organizations accumulate misfiled data in cloud storage - files placed in directories based on arrival time rather than their actual business date. Traditional approaches require:

- **Custom scripts**: Error-prone, hard to maintain
- **Full downloads**: Wasteful when only headers matter
- **Manual intervention**: Doesn't scale

## The Solution: Content-Aware Reflow

### Complete Pipeline

```bash
# 1. List objects
gonimbus inspect 's3://source/prefix/' --json > objects.jsonl

# 2. Transform to URIs
jq -r '"s3://bucket/" + .key' objects.jsonl > uris.txt

# 3. Probe content for derived fields
gonimbus content probe --stdin \
  --config probe.yaml \
  --emit reflow-input < uris.txt > probe.jsonl

# 4. Reflow using derived fields
gonimbus transfer reflow --stdin \
  --dest 's3://dest/landing/' \
  --rewrite-from 'prefix/{program}/{site}/{endpoint}/{folder_date}/{file}' \
  --rewrite-to '{business_date}/{program}/{site}/{file}' < probe.jsonl
```

### Example probe.yaml

```yaml
extract:
  - name: business_date
    type: xml_xpath
    xpath: //BusinessDate
  - name: folder_date
    type: xml_xpath
    xpath: //FolderDate
```

## New Commands

### `gonimbus content probe`

Extract derived fields from object content using configurable extractors:

```bash
# Probe single object
gonimbus content probe 's3://bucket/file.xml' --config probe.yaml

# Bulk probe via stdin
gonimbus content probe --stdin --config probe.yaml < uris.txt

# Output formats
--emit probe         # Raw probe results
--emit reflow-input  # Ready for transfer reflow (default)
--emit both          # Both formats
```

**Extractor Types:**

| Type        | Use Case               | Example                    |
| ----------- | ---------------------- | -------------------------- |
| `xml_xpath` | XML element extraction | `//BusinessDate`           |
| `regex`     | Pattern matching       | `date=(\d{4}-\d{2}-\d{2})` |
| `json_path` | JSON field extraction  | `$.data.timestamp`         |

**Flags:**

- `--bytes N` - byte window to read (default 4096, max 10MB)
- `--concurrency N` - parallel probe operations (default 16)
- `--config <file>` - extraction config (YAML or JSON)

### `gonimbus transfer reflow`

Copy objects while rewriting keys based on templates:

```bash
# Path-based reflow
gonimbus transfer reflow 's3://source/prefix/' \
  --dest 's3://dest/base/' \
  --rewrite-from '{program}/{site}/{date}/{file}' \
  --rewrite-to '{date}/{program}/{site}/{file}'

# Content-aware reflow (with probe output)
gonimbus transfer reflow --stdin \
  --dest 's3://dest/base/' \
  --rewrite-from '{_}/{store}/{device}/{date}/{file}' \
  --rewrite-to '{business_date}/{store}/{file}' < probe.jsonl

# Bucket to local filesystem
gonimbus transfer reflow --stdin \
  --dest 'file:///tmp/output/' \
  --rewrite-from '...' \
  --rewrite-to '...' < probe.jsonl
```

**Features:**

- Template variables from path segments or probe-derived fields
- Wildcard segments (`{_}`) for ignored path components
- Parallel copy with configurable workers (`--parallel`, default 16)
- Checkpoint/resume for large jobs (`--checkpoint`, `--resume`)
- Dry-run mode (`--dry-run`)

**Collision Handling:**

- `--on-collision log` (default) - log conflict, fail operation
- `--on-collision fail` - fail immediately on first conflict
- `--on-collision overwrite` - replace existing (requires `--overwrite`)

## file:// Provider

Transfer reflow now supports local filesystem destinations:

```bash
# Download and reorganize to local disk
gonimbus transfer reflow --stdin \
  --dest 'file:///tmp/reflow-out/' \
  --src-profile my-aws-profile \
  --rewrite-from '...' \
  --rewrite-to '...' < probe.jsonl
```

**Features:**

- Automatic directory creation
- Collision detection (file exists with different content)
- Overwrite mode for updates

## Bulk Input Support

Both `content head` and `content probe` now support bulk input via stdin:

```bash
# Bulk content head
gonimbus content head --stdin < uris.txt

# Bulk content probe
gonimbus content probe --stdin --config probe.yaml < uris.txt
```

**Features:**

- Parallel processing (`--concurrency`, default 16)
- JSONL output for pipeline composition
- Error records included in output stream

## Changes

### Added

**Content Probe (`pkg/probe/`):**

- `gonimbus content probe` command
- XPath extractor for XML content
- Regex extractor with group capture
- JSON path extractor
- Config-driven extraction rules
- `--emit probe|reflow-input|both` output modes

**Transfer Reflow (`pkg/transfer/`):**

- `gonimbus transfer reflow` command
- Template-based key rewriting
- Path variable extraction
- Probe-derived variable support
- Parallel copy with worker pool
- Checkpoint/resume with SQLite state
- Collision detection and policies

**file:// Provider (`pkg/provider/file/`):**

- Local filesystem destination support
- Directory auto-creation
- File collision detection

**Bulk Inputs:**

- `content head --stdin` for bulk operations
- `content probe --stdin` for bulk extraction
- JSONL input from `gonimbus index query` or `inspect`

### Changed

- Error records now use `gonimbus.error.v1` type consistently
- All commands emit JSONL on stdout for pipeline composition

## Upgrade Notes

No breaking changes from v0.1.6. Upgrade with:

```bash
go install github.com/3leaps/gonimbus/cmd/gonimbus@v0.1.7
```

## What's Next

v0.1.8 will focus on:

- Index checkpoints and recovery
- Enhanced `index doctor --locks` for WAL/SHM detection
- GCS provider support

## Contributors

- Dave Thompson (@3leapsdave)

## License

Apache License 2.0 - see [LICENSE](../../LICENSE)
