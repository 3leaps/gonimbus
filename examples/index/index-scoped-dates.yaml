# Example: Path-scoped index build with date partitions
#
# Use this pattern when your bucket has date-partitioned paths like:
#   s3://bucket/data/{store}/{device}/{YYYY-MM-DD}/files
#
# The scope compiler will:
#   1. Discover variable segments (stores, devices) via delimiter listing
#   2. Expand the date range to concrete prefixes
#   3. List ONLY those prefixes (99%+ reduction in listing work)
#
# Usage:
#   gonimbus index build --job examples/index/index-scoped-dates.yaml --dry-run
#   gonimbus index build --job examples/index/index-scoped-dates.yaml
#   gonimbus index build --job examples/index/index-scoped-dates.yaml --background
version: "1.0"

connection:
  provider: s3
  bucket: my-data-bucket
  base_uri: "s3://my-data-bucket/data/"
  region: us-east-1

identity:
  storage_provider: aws_s3
  cloud_provider: aws
  region_kind: aws
  region: us-east-1

build:
  source: crawl

  # SCOPE: Controls what prefixes are listed (provider-cost lever)
  # This is the key to avoiding full-bucket enumeration on date-partitioned data.
  scope:
    type: date_partitions

    # Discover variable segments before the date segment
    # Each segment is discovered via delimiter listing
    discover:
      segments:
        - index: 0  # Segment 0: discover store IDs (e.g., "store-001/", "store-002/")
        - index: 1  # Segment 1: discover device IDs under each store

    # Date segment configuration
    date:
      segment_index: 2           # Date is at segment index 2 (after store and device)
      format: "2006-01-02"       # Go date format matching folder names (YYYY-MM-DD)
      range:
        after: "2025-12-01"      # Inclusive start date
        before: "2026-01-01"     # Exclusive end date (standard interval notation)

  # MATCH: Controls what objects are ingested (index size lever)
  # Applied AFTER listing - does not reduce provider API calls
  match:
    includes:
      - "**/*.xml"
      - "**/*.json"
    excludes:
      - "**/_temporary/**"
    include_hidden: false

  crawl:
    concurrency: 8
    progress_every: 1000

# Example path structure this manifest targets:
#
#   s3://my-data-bucket/data/
#   ├── store-001/
#   │   ├── device-A/
#   │   │   ├── 2025-12-01/
#   │   │   │   └── data.xml
#   │   │   ├── 2025-12-02/
#   │   │   │   └── data.xml
#   │   │   └── ...
#   │   └── device-B/
#   │       └── ...
#   └── store-002/
#       └── ...
#
# With scope, only the date folders in range are listed.
# Without scope, ALL historical dates would be enumerated.
